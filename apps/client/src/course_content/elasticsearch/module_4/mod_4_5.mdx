# Cardinality and HyperLogLog++

How many unique users visited my site today? In SQL, you use `COUNT(DISTINCT user_id)`. In Elasticsearch, we use the **Cardinality Aggregation**.

---

## 1. The Challenge of Uniqueness

To find _exact_ distinct counts across a distributed system, every shard would have to send its entire list of unique IDs to a master node. If you have 1 billion IDs, this will crash the network and the server.

---

## 2. The Solution: HyperLogLog++

Elasticsearch uses an algorithm called **HyperLogLog++** (HLL++).

- It is an **approximate** algorithm.
- It calculates uniqueness based on the hashes of the values.
- **The Tradeoff:** It uses a tiny, fixed amount of memory (usually 1KB - 3KB) regardless of whether you are counting 100 items or 100 billion items.

---

## 3. Accuracy vs. Performance

By default, the error rate is very low (usually around 1-5%). You can control this with `precision_threshold`.

```http
"aggs": {
  "unique_visitors": {
    "cardinality": {
      "field": "user_id.keyword",
      "precision_threshold": 1000
    }
  }
}
```

_A higher `precision_threshold` means better accuracy for low counts, but uses more memory._

---

## Real-World Example: Cybersecurity Logs

A security engineer is looking for a "DDoS" attack.

- They run a **Date Histogram** (per minute).
- They nest a **Cardinality Aggregation** on the `source_ip` field.
- If they see moving from 10 unique IPs per minute to 50,000 unique IPs, they know an attack is happening. They don't need to know the _exact_ count is 50,001 or 49,998; the approximate number is enough to trigger the alarm.

---

## Hypothetical Scenario: The "CEO's Report"

The CEO wants to know the _exact_ number of unique customers who bought a specific product for tax purposes.

- **The Problem:** Cardinality is approximate. Using it for financial audits might lead to slight discrepancies.
- **The Solution:** For small datasets or strict legal requirements, use the **`composite`** aggregation or use a traditional relational database (OLAP like DuckDB) for the final count.

## Exercises

1. **Terminology:** What does "Cardinality" mean in the context of data?
2. **True/False:** The Cardinality aggregation in Elasticsearch is always 100% accurate.
3. **Configuration:** If I increase the `precision_threshold`, does memory usage go up or down?

## Summary and Next Steps

You've mastered the basics of Elasticsearch Analytics!

In **Module 5**, we will look at how Elasticsearch handles distributed data across **Shards and Replicas**, and how to keep your cluster healthy.
